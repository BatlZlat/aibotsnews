#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è Next.js –ø—Ä–æ–µ–∫—Ç–∞
# –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ
# –ë–ï–ó–û–ü–ê–°–ù–û: –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç –¥—Ä—É–≥–∏–µ –ø—Ä–æ–µ–∫—Ç—ã

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."

# 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å—ã Next.js –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo "üìã –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã Next.js –≤ —Ç–µ–∫—É—â–µ–º –ø—Ä–æ–µ–∫—Ç–µ..."
pkill -f "next.*$(pwd)" || true
pkill -f "node.*$(pwd)" || true

# 2. –ñ–¥–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–æ—Ä—Ç–∞
echo "‚è≥ –ñ–¥–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
sleep 5

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Ä—Ç —Å–≤–æ–±–æ–¥–µ–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞)
if lsof -i :3000 > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  –ü–æ—Ä—Ç 3000 –∑–∞–Ω—è—Ç. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—à –ª–∏ —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å..."
    if lsof -i :3000 | grep -q "$(pwd)"; then
        echo "‚ùå –ù–∞—à –ø—Ä–æ—Ü–µ—Å—Å –≤—Å–µ –µ—â–µ –∑–∞–Ω–∏–º–∞–µ—Ç –ø–æ—Ä—Ç. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º..."
        sudo fuser -k 3000/tcp || true
        sleep 3
    else
        echo "‚úÖ –ü–æ—Ä—Ç 3000 –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–æ–µ–∫—Ç–æ–º. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞."
    fi
fi

# 4. –û—á–∏—â–∞–µ–º –∫—ç—à —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
echo "üßπ –û—á–∏—â–∞–µ–º –∫—ç—à —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞..."
rm -rf .next/
rm -rf node_modules/.cache/ || true
rm -rf node_modules/ || true

# 5. –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm ci --production || npm install --production

# 6. –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
echo "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
npm run build

# 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏
if [ $? -eq 0 ]; then
    echo "‚úÖ –°–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!"
    
    # 8. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–µ–∫—Ç
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
    npm start &
    
    # 9. –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
    echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
    sleep 10
    
    # 10. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
    if curl -s http://localhost:3000 > /dev/null; then
        echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:3000"
        echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
        exit 1
    fi
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏"
    exit 1
fi